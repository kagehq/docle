<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Docle React Demo</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      max-width: 1200px;
      margin: 40px auto;
      padding: 0 20px;
      background: #0a0e12;
      color: #e6eef8;
    }
    h1 { margin-bottom: 10px; }
    .subtitle { color: #9aa8b4; margin-bottom: 40px; }
    .demo { margin-bottom: 60px; }
    h2 { color: #8aa2ff; margin-bottom: 20px; }
    pre {
      background: #11161b;
      border: 1px solid #1b232b;
      border-radius: 8px;
      padding: 16px;
      overflow-x: auto;
      font-size: 13px;
    }
    code { color: #8aa2ff; }
    .playground-container { margin: 20px 0; }
    .custom-editor {
      background: #11161b;
      border: 1px solid #1b232b;
      border-radius: 8px;
      padding: 16px;
      margin: 20px 0;
    }
    textarea {
      width: 100%;
      min-height: 150px;
      background: #0c1218;
      color: #e6eef8;
      border: 1px solid #1b232b;
      border-radius: 6px;
      padding: 12px;
      font-family: 'SF Mono', Monaco, Menlo, monospace;
      font-size: 13px;
      margin-bottom: 12px;
    }
    button {
      background: #8aa2ff;
      color: #051030;
      border: none;
      border-radius: 6px;
      padding: 10px 20px;
      font-weight: 600;
      cursor: pointer;
      margin-right: 10px;
    }
    button:hover { opacity: 0.9; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .output {
      background: #0c1218;
      border: 1px solid #1b232b;
      border-radius: 6px;
      padding: 12px;
      margin-top: 12px;
      font-family: 'SF Mono', Monaco, Menlo, monospace;
      font-size: 13px;
      white-space: pre-wrap;
    }
    .error { color: #ff6b6b; }
    .success { color: #51cf66; }
    .loading { color: #9aa8b4; }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React & Babel for JSX -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useCallback, useRef } = React;

    // Mock @doclehq/react components
    
    // DoclePlayground component
    function DoclePlayground({ lang = 'python', code = '', theme = 'dark', onRun, onReady, height = '400px' }) {
      const iframeRef = useRef(null);

      const handleMessage = useCallback((event) => {
        if (event.source !== iframeRef.current?.contentWindow) return;
        const { type, data } = event.data;
        if (type === 'docle-ready') onReady?.(data);
        if (type === 'docle-result') onRun?.(data);
      }, [onRun, onReady]);

      useEffect(() => {
        window.addEventListener('message', handleMessage);
        return () => window.removeEventListener('message', handleMessage);
      }, [handleMessage]);

      const params = new URLSearchParams({
        lang,
        theme,
        code,
        readonly: 'false',
        showOutput: 'true',
        autorun: 'false'
      });
      // For local testing: http://localhost:8787
      // For production: https://api.docle.co
      const baseUrl = 'http://localhost:8787';
      const src = `${baseUrl}/embed?${params}`;

      return (
        <div style={{ width: '100%', height }}>
          <iframe
            ref={iframeRef}
            src={src}
            style={{ width: '100%', height: '100%', border: 'none', borderRadius: '8px', display: 'block' }}
            title="Docle Code Playground"
          />
        </div>
      );
    }

    // useDocle hook
    function useDocle() {
      const [result, setResult] = useState(null);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);

      const run = useCallback(async (code, options) => {
        setLoading(true);
        setError(null);
        try {
          // For production, use: https://api.docle.co/api/run
          const response = await fetch('http://localhost:8787/api/run', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code, lang: options.lang, policy: options.policy || {} })
          });
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const data = await response.json();
          setResult(data);
          return data;
        } catch (err) {
          setError(err);
          throw err;
        } finally {
          setLoading(false);
        }
      }, []);

      const reset = useCallback(() => {
        setResult(null);
        setError(null);
      }, []);

      return { run, result, loading, error, reset };
    }

    // Demo 1: Basic Playground
    function Demo1() {
      const [lastResult, setLastResult] = useState(null);

      return (
        <div className="demo">
          <h2>1. Basic Playground Component</h2>
          <p>Simple embedded playground with callback</p>
          
          <DoclePlayground
            lang="python"
            code="print('Hello from React!')\nfor i in range(3):\n    print(f'Count: {i}')"
            onRun={(result) => {
              console.log('Result:', result);
              setLastResult(result);
            }}
          />

          {lastResult && (
            <div className="output success">
              ✓ Executed in {lastResult.usage?.durationMs || 0}ms
            </div>
          )}

          <pre><code>{`<DoclePlayground
  lang="python"
  code="print('Hello from React!')"
  onRun={(result) => console.log(result)}
/>`}</code></pre>
        </div>
      );
    }

    // Demo 2: Custom Editor with useDocle
    function Demo2() {
      const { run, result, loading, error } = useDocle();
      const [code, setCode] = useState('print("Custom editor")\\nprint("Using useDocle hook")');

      const handleRun = async () => {
        await run(code, { lang: 'python' });
      };

      return (
        <div className="demo">
          <h2>2. Custom Editor (useDocle Hook)</h2>
          <p>Build your own UI with the headless hook</p>

          <div className="custom-editor">
            <textarea
              value={code}
              onChange={(e) => setCode(e.target.value)}
              placeholder="Enter your code..."
            />
            <button onClick={handleRun} disabled={loading}>
              {loading ? '⏳ Running...' : '▶ Run Code'}
            </button>
            <button onClick={() => setCode('')} disabled={loading}>
              Clear
            </button>
            
            {loading && <div className="output loading">Executing...</div>}
            {result && !error && (
              <div className="output success">
                <strong>Output:</strong>
                <div>{result.stdout || '(no output)'}</div>
                {result.stderr && <div className="error">{result.stderr}</div>}
                <div style={{ marginTop: '8px', fontSize: '11px', opacity: 0.7 }}>
                  Exit code: {result.exitCode} | Duration: {result.usage?.durationMs || 0}ms
                </div>
              </div>
            )}
            {error && (
              <div className="output error">
                <strong>Error:</strong> {error.message}
              </div>
            )}
          </div>

          <pre><code>{`const { run, result, loading, error } = useDocle();
const [code, setCode] = useState('print("Hello")');

const handleRun = async () => {
  await run(code, { lang: 'python' });
};`}</code></pre>
        </div>
      );
    }

    // Demo 3: Multi-language
    function Demo3() {
      const [lang, setLang] = useState('python');
      const codes = {
        python: 'def greet(name):\\n    return f"Hello, {name}!"\\n\\nprint(greet("React"))',
        node: 'function greet(name) {\\n  return `Hello, ${name}!`;\\n}\\n\\nconsole.log(greet("React"));'
      };

      return (
        <div className="demo">
          <h2>3. Multi-Language Support</h2>
          <p>Switch between Python and Node.js</p>

          <div style={{ marginBottom: '12px' }}>
            <button onClick={() => setLang('python')}>Python</button>
            <button onClick={() => setLang('node')}>Node.js</button>
          </div>

          <DoclePlayground
            key={lang}
            lang={lang}
            code={codes[lang]}
            height="350px"
          />

          <pre><code>{`const [lang, setLang] = useState('python');

<DoclePlayground
  lang={lang}
  code={langSpecificCode[lang]}
/>`}</code></pre>
        </div>
      );
    }

    // Main App
    function App() {
      return (
        <>
          <h1>Docle React Demo</h1>
          <p className="subtitle">Interactive code execution with React components</p>

          <Demo1 />
          <Demo2 />
          <Demo3 />

          <footer style={{ marginTop: '60px', paddingTop: '40px', borderTop: '1px solid #1b232b', color: '#9aa8b4', textAlign: 'center' }}>
            <p>Built with <code>@doclehq/react</code> on Cloudflare</p>
          </footer>
        </>
      );
    }

    // Render
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>

